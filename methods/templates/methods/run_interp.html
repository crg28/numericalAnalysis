{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto py-8">

  <h1 class="text-4xl font-bold mb-6">{{ method_name }}</h1>

  <div class="flex gap-6 items-start">

    <!-- LEFT SIDE -->
    <div class="flex-1 min-w-[60%]">

      <div class="bg-white shadow rounded-2xl p-6">
        <form method="post" id="method-form">
          {% csrf_token %}
          {% for field in form %}
          <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-1">{{ field.label }}</label>
            {{ field }}
            {% if field.help_text %}
            <p class="text-xs text-gray-500 mt-1">{{ field.help_text }}</p>
            {% endif %}
            {% if field.errors %}
            <p class="text-sm text-red-600">{{ field.errors|striptags }}</p>
            {% endif %}
          </div>
          {% endfor %}

          <div class="flex gap-4">
            <button class="px-5 py-2 rounded-xl bg-red-500 text-white font-semibold hover:bg-red-600">
              Run
            </button>

            <button type="button" id="plot-btn"
              class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600">
              ðŸ“ˆ Graph
            </button>
          </div>
        </form>
      </div>

      {% if error %}
      <div class="mt-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl">
        {{ error }}
      </div>
      {% endif %}

      {% if poly %}
      <div class="mt-6 bg-white shadow rounded-2xl p-6">
        <h3 class="text-xl font-semibold mb-3">Result</h3>
        <pre class="whitespace-pre-wrap text-sm">{{ poly }}</pre>
      </div>
      {% endif %}

      {% if eval_result %}
      <div class="mt-6 bg-white shadow rounded-2xl p-6">
        <h3 class="text-xl font-semibold mb-3">Evaluation at X</h3>
        <pre class="whitespace-pre-wrap text-sm">{{ eval_result }}</pre>
      </div>
      {% endif %}

    </div>

    <!-- RIGHT SIDE -->
    <div id="graph-card" class="w-[360px] hidden bg-white shadow rounded-2xl p-6 sticky top-10">
      <h3 class="text-xl font-semibold mb-3">Graph</h3>

      <!-- ðŸ”¹ RANGO DE LA GRÃFICA -->
      <div class="flex gap-2 mb-3 text-sm">
        <div class="flex flex-col">
          <label for="x-min" class="text-gray-600">x min</label>
          <input id="x-min" type="number" step="any" value="-10"
                 class="border rounded-lg px-2 py-1 text-sm">
        </div>

        <div class="flex flex-col">
          <label for="x-max" class="text-gray-600">x max</label>
          <input id="x-max" type="number" step="any" value="10"
                 class="border rounded-lg px-2 py-1 text-sm">
        </div>
      </div>

      <div class="flex gap-2 mb-3 text-sm">
        <div class="flex flex-col">
          <label for="y-min" class="text-gray-600">y min</label>
          <input id="y-min" type="number" step="any" value=""
                 placeholder="auto"
                 class="border rounded-lg px-2 py-1 text-sm">
        </div>

        <div class="flex flex-col">
          <label for="y-max" class="text-gray-600">y max</label>
          <input id="y-max" type="number" step="any" value=""
                 placeholder="auto"
                 class="border rounded-lg px-2 py-1 text-sm">
        </div>
      </div>
      <!-- ðŸ”¹ FIN RANGO -->

      <div id="plot-area" class="w-full h-[260px]"></div>
    </div>

  </div>

  {% if plot_data %}
    <script id="plot-data" type="application/json">
        {{ plot_data|safe }}
    </script>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const plotBtn   = document.getElementById("plot-btn");
  const plotArea  = document.getElementById("plot-area");
  const graphCard = document.getElementById("graph-card");

  const xMinInput = document.getElementById("x-min");
  const xMaxInput = document.getElementById("x-max");
  const yMinInput = document.getElementById("y-min");
  const yMaxInput = document.getElementById("y-max");

  plotBtn.addEventListener("click", () => {

    const raw = document.getElementById("plot-data");
    if (!raw) {
      alert("No hay datos de spline para graficar.");
      return;
    }

    let data;
    try {
      data = JSON.parse(raw.innerHTML.trim());
    } catch (e) {
      console.error("JSON invÃ¡lido:", raw.innerHTML);
      alert("Error: los datos del spline son invÃ¡lidos.");
      return;
    }

    const traces = [];

    data.segments.forEach(seg => {
      traces.push({
        x: seg.xs,
        y: seg.ys,
        mode: "lines",
        line: { width: 3 },
        name: "Spline",
        showlegend: false,
      });
    });

    const px = data.points.map(p => p.x);
    const py = data.points.map(p => p.y);

    traces.push({
      x: px,
      y: py,
      mode: "markers",
      marker: { size: 7, color: "red" },
      name: "Points",
    });

    graphCard.classList.remove("hidden");

    const minX = Math.min(...px);
    const maxX = Math.max(...px);
    const minY = Math.min(...py);
    const maxY = Math.max(...py);

    if (!xMinInput.value) xMinInput.value = minX;
    if (!xMaxInput.value) xMaxInput.value = maxX;
    if (!yMinInput.value) yMinInput.value = minY;
    if (!yMaxInput.value) yMaxInput.value = maxY;

    let xMin = parseFloat(xMinInput.value);
    let xMax = parseFloat(xMaxInput.value);
    let yMin = parseFloat(yMinInput.value);
    let yMax = parseFloat(yMaxInput.value);

    const layout = {
      margin: { t: 10, r: 10, l: 40, b: 40 },
      xaxis: { title: "x" },
      yaxis: { title: "y" }
    };

    if (!isNaN(xMin) && !isNaN(xMax) && xMin < xMax) {
      layout.xaxis.range = [xMin, xMax];
    }
    if (!isNaN(yMin) && !isNaN(yMax) && yMin < yMax) {
      layout.yaxis.range = [yMin, yMax];
    }

    Plotly.newPlot(plotArea, traces, layout);
  });

});
</script>
{% endblock %}
