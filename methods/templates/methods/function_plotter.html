{% extends "base.html" %}
{% load static %}

{% block title %}Function Plotter{% endblock %}

{% block extra_css %}
<style>
  .plotter-layout {
    display: grid;
    grid-template-columns: 260px minmax(0, 1fr);
    gap: 1.5rem;
    align-items: flex-start;
  }

  .plotter-sidebar {
    background: #ffffff;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  .plotter-input-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .plotter-input-bullet {
    font-weight: 600;
    min-width: 48px;
  }

  .plotter-input-row input {
    flex: 1;
  }

  .plotter-help {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.75rem;
  }

  .plotter-hints {
    margin-top: 0.75rem;
    font-size: 0.83rem;
    background: #fff6e5;
    border-radius: 8px;
    padding: 0.6rem 0.75rem;
    border: 1px solid #ffd391;
  }

  .plotter-hints strong {
    font-weight: 600;
  }

  .plotter-hints code {
    font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    font-size: 0.8rem;
    background: rgba(0,0,0,0.03);
    padding: 0 0.2rem;
    border-radius: 4px;
  }

  .plotter-graph-wrapper {
    background: #ffffff;
    border-radius: 12px;
    padding: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  /* Dropdown historial */
  .fx-history-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    padding: 4px 0;
    font-size: 0.85rem;
    max-height: 180px;
    overflow-y: auto;
    z-index: 50;
    min-width: 220px;
  }
  .fx-history-item {
    padding: 4px 8px;
    cursor: pointer;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
  }
  .fx-history-item:hover {
    background: #f3f4f6;
  }
  .fx-history-empty {
    padding: 4px 8px;
    color: #9ca3af;
    font-style: italic;
  }

  @media (max-width: 900px) {
    .plotter-layout {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<h1>Function Plotter</h1>

<div class="plotter-layout">
  <!-- Sidebar -->
  <aside class="plotter-sidebar">

    <!-- f(x) -->
    <div class="plotter-input-row" style="position:relative;">
      <span class="plotter-input-bullet">f(x) =</span>
      <input id="fx-input" type="text" placeholder="e.g. sin(x), x^3 - 2*x, exp(-x)*cos(3x)">
      <div id="fx-history" class="fx-history-dropdown hidden"></div>
    </div>

    <!-- Dominio: x min / x max -->
    <div class="plotter-input-row">
      <span class="plotter-input-bullet">x min</span>
      <input id="x-min" type="number" step="any" value="-10">
    </div>

    <div class="plotter-input-row">
      <span class="plotter-input-bullet">x max</span>
      <input id="x-max" type="number" step="any" value="10">
    </div>

    <button id="plot-btn" class="btn btn-primary" style="margin-top: 1rem;">
      Plot
    </button>

    <p class="plotter-help">
      Default domain is [-10, 10]. You can change it using <strong>x min</strong> and <strong>x max</strong>.
    </p>

    <!-- Caja de sugerencias -->
    <div class="plotter-hints">
      <strong>Tips for writing functions:</strong>
      <ul style="margin: 0.3rem 0 0 1rem; padding: 0;">
        <li>Exponential: <code>exp(x)</code> (instead of <code>e^x</code>).</li>
        <li>Natural log: <code>log(x)</code> (not <code>ln(x)</code>).</li>
        <li>Square root: <code>sqrt(x)</code>.</li>
        <li>Absolute value: <code>abs(x)</code>.</li>
        <li><code>sin(x)^2</code> instead of <code>sin^2(x)</code>.</li>
        <li>Use <code>^</code> for powers (e.g. <code>x^3 - 2*x</code>).</li>
      </ul>
    </div>

  </aside>

  <!-- Graph -->
  <section class="plotter-graph-wrapper">
    <div id="plotter-graph" style="width: 100%; height: 65vh;"></div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const fxInput   = document.getElementById("fx-input");
    const xMinInput = document.getElementById("x-min");
    const xMaxInput = document.getElementById("x-max");
    const plotBtn   = document.getElementById("plot-btn");
    const graphDiv  = document.getElementById("plotter-graph");
    const historyBox = document.getElementById("fx-history");
    const storageKey = "na_hist_plotter_fx";

    function loadHistory() {
        try {
            return JSON.parse(localStorage.getItem(storageKey) || "[]");
        } catch {
            return [];
        }
    }
    function saveHistory(items) {
        localStorage.setItem(storageKey, JSON.stringify(items));
    }
    function pushHistory(expr) {
        expr = (expr || "").trim();
        if (!expr) return;
        let hist = loadHistory();
        const idx = hist.indexOf(expr);
        if (idx >= 0) hist.splice(idx, 1);
        hist.unshift(expr);
        if (hist.length > 20) hist = hist.slice(0, 20);
        saveHistory(hist);
    }

    function showHistory() {
        const hist = loadHistory();
        if (!hist.length) {
            historyBox.innerHTML = '<div class="fx-history-empty">No history yet</div>';
        } else {
            historyBox.innerHTML = hist
                .map(h => `<div class="fx-history-item">${h}</div>`)
                .join("");
        }
        historyBox.classList.remove("hidden");
    }
    function hideHistory() {
        historyBox.classList.add("hidden");
    }

    fxInput.addEventListener("focus", showHistory);
    fxInput.addEventListener("click", showHistory);

    historyBox.addEventListener("click", (e) => {
        const item = e.target.closest(".fx-history-item");
        if (!item) return;
        fxInput.value = item.textContent.trim();
        hideHistory();
    });

    document.addEventListener("click", (e) => {
        if (e.target === fxInput) return;
        if (historyBox.contains(e.target)) return;
        hideHistory();
    });

    function plotFunction() {
        const expr = fxInput.value.trim();
        if (!expr) return;

        let f;
        try {
            f = math.compile(expr);
        } catch (err) {
            alert("Invalid expression. Check your syntax.");
            return;
        }

        let xMin = parseFloat(xMinInput.value);
        let xMax = parseFloat(xMaxInput.value);

        if (isNaN(xMin) || isNaN(xMax)) {
            alert("Please enter valid numeric values for x min and x max.");
            return;
        }
        if (xMin >= xMax) {
            alert("x min must be strictly less than x max.");
            return;
        }

        const nPoints = 400;
        const step = (xMax - xMin) / nPoints;
        const xs = math.range(xMin, xMax, step).toArray();

        let ys = [];
        try {
            ys = xs.map(x => {
                const y = f.evaluate({ x });
                return (isFinite(y) ? y : null);
            });
        } catch (error) {
            alert("Error evaluating function.");
            return;
        }

        Plotly.newPlot(graphDiv, [{
            x: xs,
            y: ys,
            mode: "lines",
            line: { color: "#007bff", width: 2 }
        }], {
            margin: { t: 10, r: 10, l: 40, b: 40 },
            xaxis: { title: "x", zeroline: true },
            yaxis: { title: "f(x)", zeroline: true }
        });

        pushHistory(expr);
    }

    plotBtn.addEventListener("click", plotFunction);
});
</script>
{% endblock %}
